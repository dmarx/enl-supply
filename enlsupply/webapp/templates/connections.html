{% extends "layout.html" %}

{% block body %}
  {% if session.username %}
  <h3>Connections</h3>
        <table class="scroll">
    <thead>
        <tr>
            <th>Agent</th>
            <th>Disconnect</th>
        </tr>
    </thead>
    <tbody>
    {% for agent in verified_neighbors %}
      <tr>
        <td> {{ agent.agent_name }} </td>
        <td> <input type="checkbox" class="sugg" name="{{ agent.groupme_id }}" value="{{ agent.groupme_id }}"> </td>
        <!-- these empty cells are just a shitty spacing hack cause I suck at webdesign -->
        <td></td> 
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
    {% else %}
      You currently are not connected to any other agents. Register connections
      to agents you can easily meet with for gear exchange suggestions.
    {% endfor %}
    </tbody>
    </table>
  
  <h3>Suggested Connections</h3>
  
    Please indicate agents for whom it would not be a significant inconvenience
    for you to meet to exchange gear.
    
    <!--
        Should add an option to specify/filter which groups to consider.
        A good approach would probably be a form listing the user's groups with 
        multi-select radio buttons they can use to specify which groups to get
        suggestions from, then we can populate suggestions based on the user's
        specification.
    -->
    <br>
    <br>
    
    <button type="button" id="submit_new_conn">Submit</button>
    
    <table class="scroll">
    <thead>
        <tr>
            <th>Connect</th>
            <th>GroupMe Nickname</th>
            <th># groups in common</th>
            <th>Shared groups</th>
        </tr>
    </thead>
    <tbody>
    {% for suggestion in suggestions %}
        <tr>
            <td>
                <input type="checkbox" class="sugg" name="{{ suggestion.id }}" value="{{ suggestion.id }}">
            </td>
            <td>{{ suggestion.nickname |join('<br>') | safe}}</td>
            <td>{{ suggestion.n_groups }}</td>
            <td>{{ suggestion.groups |join('<br>') | safe}}</td>
        </tr>
    {% else %}
        Unable to get your GroupMe groups. Try reloading the page.
    {% endfor %}
    </tbody>
    </table>
  
    <script>
    var collect_ids = function(){
        var ids = [];
        jQuery('input.sugg:checked').each(function(){
           ids.push(jQuery(this).val());
        });
        console.log(ids)
        return(ids);
    };
    
    $(function() {
      $('button').bind('click', function() {        
        $.getJSON($SCRIPT_ROOT + '/_submit_new_connections', {
        groupme_ids: collect_ids
          }, function(data) { 
          //return false;
          console.log("success");
          window.location.reload();
        });
      // this is a very dirty way of doing this...
          //window.location.reload();
          //window.location.href=window.location.href;
          //document.location.reload();
          
          /*
           Doesn't matter. Doesn't work anyway.
           If I put this inside the callback funciton, nothing happens.
           If I put it "after" the callback function, the page reloads before 
           the data ever gets sent.
          */
      });
    });
    </script>
  
  {% endif %}
  
{% endblock %}